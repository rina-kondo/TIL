## Amazon S3
Amazon S3（Amazon Simple Storage Service）は、クラウド上にデータやファイルを保存できるサービスです。

### Amazon S3の特徴
Amazon S3には、次のような特徴があります。  
- **容量無制限**. 
	保存できるデータ容量とオブジェクト数には制限がありません。ただし、1つのオブジェクトサイズは最大5TBまでです。  

- **高度な耐久性**
    S3に保存したデータは、99.999999999％（9×11）の耐久性を実現するよう設計されています。  
     
- **使いやすい価格設定**
	容量単価の月額は、0.025ドル/1GBです。  
    
- **スケーラブルで安定した性能**
    どのようなファイル数やサイズ、リクエスト数であっても一定性能を発揮できるように、複数のストレージクラスが用意されています。    
    このため、必要な性能やディスク容量などを考える必要がありません。   

### Amazon S3の位置付け 
同時に複数ファイルを転送する際に性能が低下しにくいため、大規模なデータ配信を行うアプリケーションやサービスのストレージとして利用されています。  

### AWS のストレージの種類
#### オブジェクトストレージ
- それぞれのデータを「オブジェクト」単位で記憶するストレージ。
- オブジェクト内にメタデータを含めて管理する。
- 既存のファイルとの互換性は低い
- 静的データ（例えば、画像やビデオ）、バックアップデータ、アーカイブデータに適しています。  
- Amazon S3は、オブジェクトストレージを採用しています。

#### ブロックストレージ
- データを「ブロック」の集合体として管理するストレージ。 
- 各ブロックは独立してアクセス・管理することが可能  
- 低レイテンシーでの高性能を提供できるため、データベースやトランザクション処理などのアプリケーションによく使われます
- Amazon Elastic Block Store（EBS）は、ブロックストレージを採用しています。

#### ファイルストレージ
- 一般的なパソコンで見かけるファイルシステムと同じ
- NFSやSMBなどのファイル共有プロトコルによってファイルを管理するストレージです。  
- ネットワークプロトコルが介在する分、レイテンシが高くなります。 
- 複数のユーザーまたはアプリケーションが同時にアクセスできます
- 大規模なデータを効率的に管理するのは難しい
- Amazon Elastic File System（EFS）は、NFSを使用するファイルストレージです。

### Amazon S3でよく使われる用語
- バケット: オブジェクトの保存場所。
- オブジェクト: バケットに保存されているファイル本体。
- キー: オブジェクトの識別子(id)
- メタデータ: 「システム定義メタデータ」と「ユーザー定義メタデータ」がある


### ストレージクラス
**S3標準**
- 性能：全ストレージクラスの中で最も高い
- ストレージ料金：最も高価
- データ取り出し：無料

**低頻度アクセス**
- 性能：「標準」と同じ
- ストレージ料金：「標準」よりは安価
- データの取り出し：有料

**インテリジェント・ティアリング（S3 Intelligent-Tiering）**
- アクセス頻度によって「標準」「低頻度アクセス」のいずれかを自動選択して保存
- ストレージ料金：選択中のストレージクラスの料金が適用される
- データの取り出し：無料（別途、モニタリング料金がかかる）

**1ゾーン低頻度アクセス**
- 性能：「標準」と同じ（「標準」とは異なり、1つのアベイラビリティゾーンにのみ保存される）
- ストレージ料金：3アベイラビリティゾーンの「低頻度アクセス」より安価
- データの取り出し：有料

**S3 Glacier**
- ストレージ料金：最も安価
- データの取り出し：非常に時間がかかる
- 使い方：バックアップなどのように、アクセスがほとんどないオブジェクトを格納する


### S3のアーキテクチャ(概略)
1. エンドユーザーは、S3オブジェクトを操作するために、リクエスト（PUT、GET、DELETEなど）を発行する
2. このリクエストは、インターネットを経由してS3のリージョンごとのロードバランサに到達する  
    このロードバランサは、S3の「エンドポイント」と呼ばれます。

3. ロードバランサは、いずれかのAPIサーバーにリクエストを転送する
4. APIサーバーは、メタデータを操作する場合は「メタデータストレージ」にアクセスし、ファイル本体を操作する場合は「BLOBストレージ」にアクセスし、エンドユーザーがリクエストした処理を実行する

### S3のファイル操作
**GET**
- オブジェクトをダウンロードする（S3バケットでキーを指定）
- ファイルの一部だけをダウンロードすることも可能

**PUT**
- オブジェクトをアップロードする（S3バケットでキーを指定）
- 1回のPUTオペレーションで、最大5GBまでアップロードできる
- 5GB以上の場合は、オブジェクトをいくつかに分けて複数回アップロードして結合する（マルチパートアップロード）
- マルチパートアップロードでは、5TBまでアップロードできる

**LIST**
- S3バケット内のオブジェクト一覧を取得する
- キー名にPrefixを付けると、そのPrefixを持つオブジェクトだけに限定できる
- 1回のオペレーションで、最大1,000オブジェクトまで取得できる

**COPY**
- S3内のオブジェクトを複製する
- 転送はサーバー間で行われる
- 異なるロケーション間でコピーすると、帯域料金が発生する

**DELETE**
- 任意のオブジェクトを削除する
- 1回のオペレーションで、複数オブジェクトをまとめて削除できる

**HEAD**
- オブジェクトのメタデータを取得する

**RESTORE**
- Glacierにアーカイブされているオブジェクトを復元し、上記オペレーションを行える状態にする
- または、復元せずにSELECTオペレーションを行う

**SELECT**
- CSV、JSON、Parquet形式のオブジェクトに対してSQLクエリを実行して抽出し、結果を得る

### S3へアクセスする管理
**1. IAMポリシー**
ユーザーに付与するIAMを「IAMユーザー」、サービスやプログラムに付与するIAMを「IAMロール」と言います。  
- IAMユーザーやIAMロールに対して、アクセス許可とアクセス拒否を設定する
- JSON形式のポリシードキュメントで、アクセス許可と拒否の条件を細かく制御できる
- バケットやオブジェクトにアクセスしてくるクライアント側（ツールなど）に対して、IAMポリシーを設定する  
    （クライアントはIAMユーザーとしてアクセスするため、ユーザーに設定されるIAMポリシーが有効になる）

**2. バケットポリシー**
- バケットやオブジェクトに対して、アクセス許可とアクセス拒否を設定する
- JSON形式のポリシードキュメントで、アクセス許可と拒否の条件を細かく制御できる
- クライアントからアクセスされるバケットやオブジェクトに対して、ポリシーを設定したい場合に設定する

**3. ACL（AccessControlList）**
「ACL（AccessControlList）」は、自分以外のAWSアカウントに対して、許可／拒否などを設定できる一覧表です。
- バケットやオブジェクトに対して、アクセス許可を設定する
- AWSアカウントと定義済みのアクセス許可リストを用いて、ポリシーをシンプルに記述できる
- IAMポリシーは、IAMユーザーやIAMロールに対して複数のポリシードキュメントを設定できる。  
バケットポリシーは、バケットに対して1つのポリシードキュメントしか設定できない（サイズは20KBまで）。     
この制限があるため、詳細の権限制御を行いたいときにバケットポリシーでは入り切らない場合がある。そのようなときに、ACLを使用する


### IAMポリシー・バケットポリシーの記法
IAMポリシーとバケットポリシーは、以下のように**JSON形式**で記述します。IAMポリシーの設定は多岐にわたりますが、ここではS3のアクセス管理で必要となる点を理解しましょう。   

```json
{
  "Version":"2012-10-17",
  "Id":"PolicyForCloudFrontPrivateContent",
  "Statement":[
    {
      "Sid":" Grant a CloudFront Origin Identity access to support private content",
      "Effect":"Allow",
      "Principal":{"CanonicalUser":"CloudFront Origin Identity Canonical User ID"},
      "Action":"s3:GetObject",
      "Resource":"arn:aws:s3:::examplebucket/*"
    }
  ]
}
```

- **`Version`**: IAMポリシーレンギュージのバージョンを示します
- **`Id`**: 任意のポリシー識別子です。このフィールドはオプションで、任意の文字列を設定できます。
- **`Statement`**: ポリシーの具体的な権限を定義する部分です。    
    - **`Sid`**: ステートメントの識別子です。これはオプションのフィールドで、任意の文字列を設定できます。
    - **`Effect`**: ステートメントが`"Allow"`（許可）か`"Deny"`（拒否）かを示します。
		> `"Allow"`と`"Deny"`が競合する場合、つまり同じアクションに対して一つのステートメントでは許可し、別のステートメントで拒否している場合、`"Deny"`が優先されます。これは「暗黙の許可、明示的な拒否」という原則に基づいており、セキュリティの観点からは安全側に倒すという理由か らです。  
		
    - **`Principal`**: このポリシーが適用される主体（ユーザ、アカウント、サービス、ロールなど）を示します。[  
プリンシパルの指定](https://docs.aws.amazon.com/ja_jp/IAM/latest/UserGuide/reference_policies_elements_principal.html#Principal_specifying)
    - **`Action`**: このポリシーが許可または拒否するアクションを示します。この場合は`"s3:GetObject"`なので、S3のオブジェクトを取得する操作を指しています。[ポリシーでのアクセス許可の指定](https://docs.aws.amazon.com/ja_jp/AmazonS3/latest/dev/using-with-s3-actions.html)
    - **`Resource`**: このポリシーが適用されるリソースを示します。この場合は、`"arn:aws:s3:::examplebucket/* "`で指定されたバケットの全てのオブジェクトを対象としています。`arn`はアカウント内のAWSリソースを一意に識別するAWS共通の記法です。  

<details>
  <summary>Action例</summary>
  **例：** EC2のインスタンスを開始するアクション
	```json
	"Action":"ec2:StartInstances"
	```
	**例：** EC2のインスタンスを開始、停止するアクション
	```json
	"Action":[
	  "ec2:StartInstances",
	  "ec2:StopInstances"
	]
	```
	**例：** S3のバケットとオブジェクトに対する参照系アクションを、ワイルドカードでまとめて指定する
	```json
	"Action":[
	  "s3:Get*",
	  "s3:List*"
	]
	```
</details>

<details>
  <summary>パケットポリシー使用例</summary>
  ```
  {
	  "Version":"2012-10-17",
	  "Id":"PolicyForCloudFrontPrivateContent",
	  "Statement":[
	    {
	      "Sid":" Grant a CloudFront Origin Identity access to support private content",
	      "Effect":"Allow",
	      "Principal":{"CanonicalUser":"CloudFront Origin Identity Canonical User ID"},
	      "Action":"s3:GetObject",
	      "Resource":"arn:aws:s3:::examplebucket/*"
	    }
	  ]
	}
	```
	「**Action**」には、オブジェクトを読み取るアクションが指定されています。  
	「**Principal**」には、正規ユーザーID（難読化されたAWSアカウントID）を指定します。このIDは、CloudFrontのディストリビューションを表します「**Resource**」のリソース指定部分には、バケット内の全オブジェクトを示す「**examplebucket/***」が指定されています。
	**※CloudFront：**  
	AWSのコンテンツ配信サービス（コンテンツデリバリーネットワーク：CDN）です。S3上にある画像や動画、ファイルを高速に配信する際に利用します。
</details>

### ACL
より細かなアクセス許可をリソースに適用するために使用します。S3バケットポリシーやIAMポリシーと同様に、ACLもアクセス許可を許可または拒否することができます。  
ACLはS3バケットやその中のオブジェクトに対して、より細かくアクセスを制御するために使用されます。たとえば、特定のS3オブジェクト（ファイル）に対して特定のユーザーだけがアクセスできるようにすることなどが可能です。

### ポリシーの評価論理（優先順位）
- **デフォルト拒否**
    バケットポリシーとIAMポリシーの設定が存在しない場合、アクセスは拒否される
- **明示的拒否** は、**許可** よりも優先される  
    バケットポリシーとIAMポリシーのどちらかにアクセス拒否の設定があれば、アクセスは拒否される
- ポリシーの**評価順序は、重要ではない**  
    バケットポリシーとIAMポリシーをすべて評価したうえで、上の論理で判定される
- **ポリシーによる拒否** は、**ACLによる許可** より優先される  
    ACLによる許可を併用する場合でも、バケットポリシーとIAMポリシーの拒否は優先される

### ブロックパブリックアクセス
Amazon S3には、アカウントレベルもしくはバケットレベルでバケットのパブリックアクセスを防止する「ブロックパブリックアクセス」機能があります。  
ACLやバケットポリシーでのアクセス設定にかかわらず、**最優先**でパブリックアクセスを禁止したり、パブリックアクセスの許可を設定できないように制御できます。  
**=>意図しない設定で後悔しないようにブロックするための機能**.  
デフォルトで有効になっている

### 暗号化によるデータ保護
- 転送時のデータを保護する（クライアントとAmazon S3の間でデータを送受信するとき）   追加の設定を行わなくてもSSL（Secure Sockets Layer）によってデータが暗号化される
- 保管時のデータを保護する（Amazon S3データセンター内のディスクに保管されているとき） 2023年1月5日以降、基本レベルでAmazon S3 マネージドキーによるサーバー側の暗号化 (SSE-S3) が適用されるようになりました。
- 参考:  [Amazon S3でのデータ保護](https://docs.aws.amazon.com/ja_jp/AmazonS3/latest/dev/DataDurability.html)

### バージョニング
ファイルの変更をトラッキングして変更前と変更後のファイルを別々のバージョンとして格納し、比較や復元ができるようにする機能です。

- バケット単位で、有効化／無効化を設定できる
- 削除操作は「ファイルに対する更新」として扱われるため、最新バージョンファイルを削除すると削除状態の削除マーカーが付与され、**削除前のファイルは前バージョンとして残る**
- キー名とバージョンを指定することで、**過去の任意バージョンを取得できる**
- バージョニングによって管理されている個々のバージョンのオブジェクトは、すべて課金の対象になる
- ライフサイクル管理と連携して、古いバージョンを自動的に削除できる

### ライフサイクル管理
ユースケース
- アプリケーションログなど参照期間が限られるファイルは、一定期間経過したら削除したい
- アクセス頻度の低くなった古いファイルやドキュメントは、一定期間経過したら、より安価なストレージクラスに変更したい
- アーカイブ目的で復元予定が低いデータは、定期的にGlacierにアーカイブさせたい

### S3料金
公式見るのが安牌
[Amazon S3 の料金](https://aws.amazon.com/jp/s3/pricing/)

|標準|低頻度アクセス|1ゾーン低頻度アクセス|Glacier|
|---|---|---|---|
|最初の50TB/月|$0.025/GB|$0.019/GB|$0.0152/GB|$0.005/GB|
|次の450TB/月|$0.024/GB|$0.019/GB|$0.0152/GB|$0.005/GB|
|500TB/月以上|$0.023/GB|$0.019/GB|$0.0152/GB|$0.005/GB|
|最低保存期間||30日|30日|90日|
|最小オブジェクトサイズ||128KB|128KB|32KB|

|標準|Intelligent-Tiering|低頻度アクセス|1ゾーン低頻度アクセス|Glacier|
|---|---|---|---|---|
|PUT、COPY、POST、 LISTリクエスト  <br>※1,000リクエストあたり|$0.0047|$0.0047|$0.01|$0.01|$0.0571|
|GET、SELECT、他の全リクエスト  <br>※1,000リクエストあたり|$0.00037|$0.00037|$0.001|$0.001|$0.00037|
|標準クラスからのライフサイクル移行リクエスト  <br>※1,000リクエストあたり|$0.00|$0.01|$0.01|$0.01|$0.0571|
|取り出し（容量）|$0.00|$0.00|$0.01/GB|$0.01/GB|迅速 $0.033/GB  <br>標準 $0.011/GB  <br>大容量 $0.00275/GB|

